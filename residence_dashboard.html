<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Residence Water Flow Dashboard</title>
  <link rel="stylesheet" href="residence.css">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- Styles -->
   <style>
    /* residence.css - Modern Water Flow Dashboard */

/* Base Styles */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  color: #333;
  overflow-x: hidden;
}

/* Top Bar */
.top-bar {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  padding: 1rem 2rem;
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 1rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

/* Buttons */
.logout-button, .notif-button {
  background: linear-gradient(135deg, #ff6b6b, #ee5a52);
  color: white;
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: 25px;
  cursor: pointer;
  text-decoration: none;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.logout-button:hover, .notif-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
}

.notif-button {
  position: relative;
  background: linear-gradient(135deg, #4ecdc4, #44a08d);
}

.notif-count {
  background: #ff4757;
  color: white;
  border-radius: 50%;
  padding: 0.2rem 0.5rem;
  font-size: 0.8rem;
  min-width: 20px;
  text-align: center;
}

/* Welcome Message */
#welcomeMessage {
  text-align: center;
  color: white;
  font-size: 2.5rem;
  font-weight: 300;
  margin: 2rem 0;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

/* Dashboard Grid */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 2rem;
  padding: 2rem;
  max-width: 1400px;
  margin: 0 auto;
}

/* Meter Circle */
.meter-circle {
  background: linear-gradient(135deg, #667eea, #764ba2);
  border-radius: 50%;
  width: 250px;
  height: 250px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: white;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.meter-circle::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
  transform: rotate(45deg);
  transition: all 0.6s ease;
}

.meter-circle.flowing {
  animation: pulse 2s ease-in-out;
  background: linear-gradient(135deg, #00b894, #55efc4);
}

.meter-circle.flowing::before {
  animation: shine 2s ease-in-out;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

@keyframes shine {
  0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
  100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

.meter-circle .label {
  font-size: 1rem;
  opacity: 0.9;
  margin-bottom: 0.5rem;
}

.meter-circle .reading {
  font-size: 3rem;
  font-weight: 700;
  font-family: 'Courier New', monospace;
  margin: 0.5rem 0;
}

.meter-circle .unit {
  font-size: 0.9rem;
  opacity: 0.8;
}

/* Cards */
.card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  border-radius: 20px;
  padding: 2rem;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
}

.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

.card h2 {
  margin-bottom: 1rem;
  font-size: 1.5rem;
  font-weight: 600;
}

.card p {
  margin: 0.75rem 0;
  font-size: 1.1rem;
}

#litersCard {
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05));
  border: 1px solid rgba(34, 197, 94, 0.2);
}

#billCard {
  background: linear-gradient(135deg, rgba(56, 189, 248, 0.1), rgba(56, 189, 248, 0.05));
  border: 1px solid rgba(56, 189, 248, 0.2);
}

/* Switch Container */
.switch-container {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  border-radius: 20px;
  padding: 2rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 1.5rem;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.switch-container p {
  font-size: 1.2rem;
  font-weight: 600;
  color: #333;
}

/* Toggle Switch */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 80px;
  height: 40px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, #ccc, #999);
  transition: all 0.4s ease;
  border-radius: 40px;
  box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
}

.slider:before {
  position: absolute;
  content: "";
  height: 32px;
  width: 32px;
  left: 4px;
  bottom: 4px;
  background: white;
  transition: all 0.4s ease;
  border-radius: 50%;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

input:checked + .slider {
  background: linear-gradient(135deg, #00b894, #55efc4);
}

input:checked + .slider:before {
  transform: translateX(40px);
}

/* Alert Box */
#alertBox {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #ff6b6b, #ee5a52);
  color: white;
  padding: 1rem 2rem;
  border-radius: 10px;
  box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
  z-index: 1000;
  display: none;
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
  to { transform: translateX(-50%) translateY(0); opacity: 1; }
}

/* Notification Popup */
.notif-popup {
  position: absolute;
  top: 100%;
  right: 0;
  background: white;
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  min-width: 300px;
  max-height: 400px;
  overflow-y: auto;
  display: none;
  z-index: 1000;
  margin-top: 0.5rem;
}

.notif-popup ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.notif-popup li {
  padding: 1rem;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: between;
  align-items: center;
  transition: background 0.2s ease;
}

.notif-popup li:hover {
  background: #f8f9fa;
}

.notif-popup li:last-child {
  border-bottom: none;
}

.notif-popup button {
  background: #ff4757;
  color: white;
  border: none;
  border-radius: 50%;
  width: 25px;
  height: 25px;
  cursor: pointer;
  font-size: 0.8rem;
  margin-left: auto;
}

/* Chat Popup */
.chat-popup {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 350px;
  height: 500px;
  background: white;
  border-radius: 20px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  display: none;
  flex-direction: column;
  z-index: 1000;
  overflow: hidden;
}

.chat-header {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  padding: 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.close-btn {
  background: none;
  border: none;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Modern Instagram-Style Chat CSS */

.chat-popup {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 380px;
  height: 600px;
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
  display: none;
  flex-direction: column;
  z-index: 1000;
  overflow: hidden;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  border: 1px solid #e0e0e0;
}

/* Chat Header */
.chat-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 1.2rem 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  position: relative;
}

.chat-header::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: rgba(255, 255, 255, 0.2);
}

.chat-header span {
  font-weight: 600;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.chat-header span::before {
  content: 'ðŸ’¬';
  font-size: 1.2rem;
}

.close-btn {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.close-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(1.1);
}

/* Chat Messages Area */
.chat-messages {
  flex: 1;
  padding: 1.5rem;
  overflow-y: auto;
  background: #fafafa;
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
}

/* Custom Scrollbar for Chat */
.chat-messages::-webkit-scrollbar {
  width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb {
  background: #c5c5c5;
  border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
  background: #a5a5a5;
}

/* Message Bubbles */
.chat-messages div {
  margin: 0.2rem 0;
  padding: 0.8rem 1.2rem;
  border-radius: 20px;
  max-width: 75%;
  word-wrap: break-word;
  position: relative;
  animation: messageSlide 0.3s ease-out;
  line-height: 1.4;
  font-size: 0.95rem;
}

@keyframes messageSlide {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Sent Messages (User) */
.chat-messages .sent {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  margin-left: auto;
  border-bottom-right-radius: 6px;
  align-self: flex-end;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.chat-messages .sent::before {
  content: '';
  position: absolute;
  bottom: 0;
  right: -8px;
  width: 0;
  height: 0;
  border-left: 8px solid #667eea;
  border-top: 8px solid transparent;
  border-bottom: 8px solid transparent;
}

/* Received Messages (Admin/Employee) */
.chat-messages .received {
  background: white;
  color: #262626;
  margin-right: auto;
  border-bottom-left-radius: 6px;
  align-self: flex-start;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  border: 1px solid #efefef;
}

.chat-messages .received::before {
  content: '';
  position: absolute;
  bottom: 0;
  left: -8px;
  width: 0;
  height: 0;
  border-right: 8px solid white;
  border-top: 8px solid transparent;
  border-bottom: 8px solid transparent;
}

/* Message Metadata (Time) */
.message-time {
  display: block;
  font-size: 0.7rem;
  opacity: 0.7;
  margin-top: 0.3rem;
  text-align: right;
}

.chat-messages .received .message-time {
  text-align: left;
  color: #8e8e8e;
}

/* Chat Input Form */
.chat-form {
  display: flex;
  padding: 1.2rem 1.5rem;
  background: white;
  border-top: 1px solid #efefef;
  gap: 0.8rem;
  align-items: center;
}

.chat-form input {
  flex: 1;
  padding: 0.9rem 1.2rem;
  border: 1px solid #e0e0e0;
  border-radius: 25px;
  outline: none;
  font-size: 0.95rem;
  background: #fafafa;
  transition: all 0.3s ease;
}

.chat-form input:focus {
  border-color: #667eea;
  background: white;
  box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
}

.chat-form input::placeholder {
  color: #8e8e8e;
}

.chat-form button {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border: none;
  border-radius: 50%;
  width: 44px;
  height: 44px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
}

.chat-form button:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.chat-form button:active {
  transform: scale(0.95);
}

.chat-form button::before {
  content: 'âž¤';
  font-size: 1rem;
  font-weight: bold;
}

/* Typing Indicator */
.typing-indicator {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 1rem 1.2rem;
  background: white;
  border-radius: 20px;
  margin-right: auto;
  align-self: flex-start;
  border: 1px solid #efefef;
  max-width: 80px;
}

.typing-dots {
  display: flex;
  gap: 3px;
}

.typing-dot {
  width: 6px;
  height: 6px;
  background: #8e8e8e;
  border-radius: 50%;
  animation: typingBounce 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes typingBounce {
  0%, 80%, 100% {
    transform: scale(0.8);
    opacity: 0.5;
  }
  40% {
    transform: scale(1);
    opacity: 1;
  }
}

/* Online Status */
.online-status {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.8rem;
  opacity: 0.8;
  margin-top: 0.2rem;
}

.status-dot {
  width: 8px;
  height: 8px;
  background: #00b894;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

/* Message Read Receipts */
.read-receipt {
  font-size: 0.7rem;
  opacity: 0.7;
  margin-top: 0.2rem;
  display: flex;
  align-items: center;
  gap: 0.2rem;
}

.read-receipt::before {
  content: 'âœ“âœ“';
  color: #667eea;
}

/* Chat Header Actions */
.chat-actions {
  display: flex;
  gap: 0.5rem;
}

.chat-action-btn {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.chat-action-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(1.1);
}

/* Empty State */
.chat-empty {
  text-align: center;
  color: #8e8e8e;
  padding: 3rem 2rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
}

.chat-empty::before {
  content: 'ðŸ’¬';
  font-size: 3rem;
  opacity: 0.5;
}

.chat-empty h3 {
  font-weight: 600;
  color: #262626;
  margin: 0;
}

.chat-empty p {
  margin: 0;
  font-size: 0.9rem;
}

/* Message Reactions */
.message-reactions {
  display: flex;
  gap: 0.3rem;
  margin-top: 0.5rem;
  flex-wrap: wrap;
}

.reaction {
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid #efefef;
  border-radius: 12px;
  padding: 0.2rem 0.5rem;
  font-size: 0.7rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.reaction:hover {
  background: #f8f9fa;
  transform: scale(1.05);
}

/* Responsive Design */
@media (max-width: 768px) {
  .chat-popup {
    width: calc(100vw - 40px);
    height: 70vh;
    bottom: 10px;
    right: 10px;
    left: 10px;
  }
  
  .chat-messages div {
    max-width: 85%;
  }
  
  .chat-form {
    padding: 1rem;
  }
}

/* Dark Mode Support */
@media (prefers-color-scheme: dark) {
  .chat-popup {
    background: #1a1a1a;
    border-color: #333;
  }
  
  .chat-messages {
    background: #121212;
  }
  
  .chat-messages .received {
    background: #2a2a2a;
    color: #fff;
    border-color: #333;
  }
  
  .chat-form {
    background: #1a1a1a;
    border-color: #333;
  }
  
  .chat-form input {
    background: #2a2a2a;
    border-color: #333;
    color: #fff;
  }
  
  .chat-form input:focus {
    border-color: #667eea;
    background: #2a2a2a;
  }
}

/* Message Selection */
.chat-messages div.selected {
  background: rgba(102, 126, 234, 0.1);
  border: 1px solid #667eea;
}

/* Smooth Transitions */
.chat-popup, .chat-messages div, .chat-form button {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Focus States for Accessibility */
.chat-form button:focus, .close-btn:focus {
  outline: 2px solid #667eea;
  outline-offset: 2px;
}
/* Responsive Design */
@media (max-width: 768px) {
  .top-bar {
    padding: 1rem;
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .dashboard-grid {
    grid-template-columns: 1fr;
    padding: 1rem;
    gap: 1rem;
  }
  
  .meter-circle {
    width: 200px;
    height: 200px;
  }
  
  .meter-circle .reading {
    font-size: 2.5rem;
  }
  
  #welcomeMessage {
    font-size: 2rem;
    margin: 1rem 0;
  }
  
  .chat-popup {
    width: calc(100vw - 40px);
    height: 400px;
    right: 20px;
    left: 20px;
  }
}

/* Loading States */
.loading {
  opacity: 0.6;
  pointer-events: none;
}

/* Custom Scrollbar */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}

::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #667eea, #764ba2);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(135deg, #5a6fd8, #6a4190);
}

/* residence.css - Ultra Modern Water Flow Dashboard */

/* Base Styles */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  color: #333;
  overflow-x: hidden;
  position: relative;
}

/* Animated Background */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.2) 0%, transparent 50%),
    radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
  z-index: -1;
  animation: backgroundShift 15s ease-in-out infinite;
}

@keyframes backgroundShift {
  0%, 100% { transform: scale(1) rotate(0deg); }
  50% { transform: scale(1.1) rotate(1deg); }
}

/* Top Bar */
.top-bar {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(20px);
  padding: 1.2rem 2.5rem;
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 1.2rem;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  position: relative;
  z-index: 100;
}

/* Buttons */
.logout-button, .notif-button {
  background: linear-gradient(135deg, #ff6b6b, #ee5a52);
  color: white;
  border: none;
  padding: 0.8rem 1.8rem;
  border-radius: 50px;
  cursor: pointer;
  text-decoration: none;
  font-weight: 600;
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  box-shadow: 0 6px 20px rgba(255, 107, 107, 0.3);
  display: inline-flex;
  align-items: center;
  gap: 0.6rem;
  position: relative;
  overflow: hidden;
}

.logout-button::before, .notif-button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  transition: left 0.6s;
}

.logout-button:hover::before, .notif-button:hover::before {
  left: 100%;
}

.logout-button:hover, .notif-button:hover {
  transform: translateY(-3px) scale(1.05);
  box-shadow: 0 10px 25px rgba(255, 107, 107, 0.5);
}

.notif-button {
  background: linear-gradient(135deg, #4ecdc4, #44a08d);
  box-shadow: 0 6px 20px rgba(78, 205, 196, 0.3);
}

.notif-count {
  background: linear-gradient(135deg, #ff4757, #ff3742);
  color: white;
  border-radius: 50%;
  padding: 0.3rem 0.6rem;
  font-size: 0.8rem;
  min-width: 24px;
  text-align: center;
  font-weight: bold;
  box-shadow: 0 3px 10px rgba(255, 71, 87, 0.4);
  animation: pulse 2s infinite;
}

/* Welcome Message */
#welcomeMessage {
  text-align: center;
  color: white;
  font-size: 3rem;
  font-weight: 300;
  margin: 3rem 0;
  text-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  position: relative;
  display: inline-block;
  left: 50%;
  transform: translateX(-50%);
}

#welcomeMessage::after {
  content: '';
  position: absolute;
  bottom: -10px;
  left: 25%;
  width: 50%;
  height: 3px;
  background: linear-gradient(90deg, transparent, #fff, transparent);
  border-radius: 50%;
}

/* Dashboard Grid */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 2.5rem;
  padding: 2.5rem;
  max-width: 1400px;
  margin: 0 auto;
}

/* Enhanced Meter Circle */
.meter-circle {
  background: linear-gradient(135deg, #667eea, #764ba2);
  border-radius: 50%;
  width: 280px;
  height: 280px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: white;
  box-shadow: 
    0 15px 35px rgba(0, 0, 0, 0.3),
    inset 0 5px 15px rgba(255, 255, 255, 0.2);
  transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  position: relative;
  overflow: hidden;
  border: 3px solid rgba(255, 255, 255, 0.1);
}

.meter-circle::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
  transform: rotate(45deg);
  transition: all 0.8s ease;
}

.meter-circle.flowing {
  animation: waterFlow 2s ease-in-out;
  background: linear-gradient(135deg, #00b894, #55efc4, #00b894);
}

.meter-circle.liters-active {
  background: linear-gradient(135deg, #00b894, #55efc4, #00b894);
  animation: litersPulse 1.5s ease-in-out;
  box-shadow: 
    0 0 30px rgba(0, 184, 148, 0.5),
    0 15px 35px rgba(0, 0, 0, 0.3);
}

.meter-circle.liters-active::after {
  content: '';
  position: absolute;
  top: -10px;
  left: -10px;
  right: -10px;
  bottom: -10px;
  background: linear-gradient(135deg, #00b894, #55efc4);
  border-radius: 50%;
  z-index: -1;
  animation: ripple 2s ease-out infinite;
  opacity: 0.5;
}

@keyframes waterFlow {
  0%, 100% { 
    transform: scale(1) rotate(0deg);
    background: linear-gradient(135deg, #667eea, #764ba2);
  }
  25% { 
    transform: scale(1.08) rotate(2deg);
    background: linear-gradient(135deg, #00b894, #55efc4);
  }
  50% { 
    transform: scale(1.05) rotate(-1deg);
    background: linear-gradient(135deg, #55efc4, #00b894);
  }
  75% { 
    transform: scale(1.08) rotate(1deg);
    background: linear-gradient(135deg, #00b894, #55efc4);
  }
}

@keyframes litersPulse {
  0% { 
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(0, 184, 148, 0.7);
  }
  50% { 
    transform: scale(1.05);
    box-shadow: 0 0 0 20px rgba(0, 184, 148, 0);
  }
  100% { 
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(0, 184, 148, 0);
  }
}

@keyframes ripple {
  0% {
    transform: scale(1);
    opacity: 0.5;
  }
  100% {
    transform: scale(1.2);
    opacity: 0;
  }
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

.meter-circle .label {
  font-size: 1.1rem;
  opacity: 0.9;
  margin-bottom: 0.8rem;
  font-weight: 500;
  letter-spacing: 1px;
  text-transform: uppercase;
}

.meter-circle .reading {
  font-size: 3.5rem;
  font-weight: 800;
  font-family: 'Courier New', monospace;
  margin: 0.8rem 0;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
  background: linear-gradient(135deg, #fff, #f0f0f0);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  transition: all 0.3s ease;
}

.meter-circle.liters-active .reading {
  background: linear-gradient(135deg, #fff, #55efc4);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: textGlow 1s ease-in-out infinite alternate;
}

@keyframes textGlow {
  from { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5); }
  to { text-shadow: 0 0 20px rgba(85, 239, 196, 0.8); }
}

.meter-circle .unit {
  font-size: 1rem;
  opacity: 0.8;
  font-weight: 500;
  letter-spacing: 1px;
}

/* Water Droplet Animation */
.water-droplets {
  position: absolute;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.droplet {
  position: absolute;
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 50%;
  animation: fall linear infinite;
}

@keyframes fall {
  to { transform: translateY(280px) rotate(360deg); }
}

/* Cards */
.card {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(20px);
  border-radius: 25px;
  padding: 2.5rem;
  box-shadow: 
    0 8px 32px rgba(0, 0, 0, 0.1),
    inset 0 1px 0 rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  position: relative;
  overflow: hidden;
}

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  transition: left 0.6s;
}

.card:hover::before {
  left: 100%;
}

.card:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 
    0 15px 40px rgba(0, 0, 0, 0.2),
    inset 0 1px 0 rgba(255, 255, 255, 0.3);
}

.card h2 {
  margin-bottom: 1.5rem;
  font-size: 1.6rem;
  font-weight: 600;
  background: linear-gradient(135deg, #fff, #f0f0f0);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.card p {
  margin: 1rem 0;
  font-size: 1.2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.card strong {
  color: rgba(255, 255, 255, 0.9);
}

.card span {
  font-weight: 600;
  background: linear-gradient(135deg, #fff, #f0f0f0);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

#litersCard {
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.05));
  border: 1px solid rgba(34, 197, 94, 0.3);
}

#litersCard:hover {
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.25), rgba(34, 197, 94, 0.1));
}

#billCard {
  background: linear-gradient(135deg, rgba(56, 189, 248, 0.15), rgba(56, 189, 248, 0.05));
  border: 1px solid rgba(56, 189, 248, 0.3);
}

#billCard:hover {
  background: linear-gradient(135deg, rgba(56, 189, 248, 0.25), rgba(56, 189, 248, 0.1));
}

/* Switch Container */
.switch-container {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(20px);
  border-radius: 25px;
  padding: 2.5rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 2rem;
  box-shadow: 
    0 8px 32px rgba(0, 0, 0, 0.1),
    inset 0 1px 0 rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.4s ease;
}

.switch-container:hover {
  transform: translateY(-5px);
  box-shadow: 
    0 12px 40px rgba(0, 0, 0, 0.15),
    inset 0 1px 0 rgba(255, 255, 255, 0.3);
}

.switch-container p {
  font-size: 1.3rem;
  font-weight: 600;
  background: linear-gradient(135deg, #fff, #f0f0f0);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* Enhanced Toggle Switch */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 90px;
  height: 45px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, #ccc, #999);
  transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  border-radius: 45px;
  box-shadow: 
    inset 0 2px 5px rgba(0, 0, 0, 0.2),
    0 4px 15px rgba(0, 0, 0, 0.1);
}

.slider:before {
  position: absolute;
  content: "";
  height: 37px;
  width: 37px;
  left: 4px;
  bottom: 4px;
  background: linear-gradient(135deg, #fff, #f0f0f0);
  transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  border-radius: 50%;
  box-shadow: 
    0 3px 8px rgba(0, 0, 0, 0.2),
    inset 0 -2px 3px rgba(0, 0, 0, 0.1);
}

input:checked + .slider {
  background: linear-gradient(135deg, #00b894, #55efc4);
  box-shadow: 
    inset 0 2px 5px rgba(0, 0, 0, 0.2),
    0 4px 20px rgba(0, 184, 148, 0.4);
}

input:checked + .slider:before {
  transform: translateX(45px);
  box-shadow: 
    0 3px 10px rgba(0, 0, 0, 0.3),
    inset 0 -2px 3px rgba(0, 0, 0, 0.1);
}

/* Alert Box */
#alertBox {
  position: fixed;
  top: 30px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #ff6b6b, #ee5a52);
  color: white;
  padding: 1.2rem 2.5rem;
  border-radius: 15px;
  box-shadow: 
    0 8px 25px rgba(255, 107, 107, 0.4),
    0 0 0 1px rgba(255, 255, 255, 0.1);
  z-index: 1000;
  display: none;
  animation: slideDown 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  font-weight: 600;
}

@keyframes slideDown {
  from { 
    transform: translateX(-50%) translateY(-30px); 
    opacity: 0; 
  }
  to { 
    transform: translateX(-50%) translateY(0); 
    opacity: 1; 
  }
}

/* Rest of the CSS remains the same for notifications, chat, etc. */
/* ... (previous notification and chat styles) ... */

/* Responsive Design */
@media (max-width: 768px) {
  .top-bar {
    padding: 1rem;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1rem;
  }
  
  .dashboard-grid {
    grid-template-columns: 1fr;
    padding: 1.5rem;
    gap: 1.5rem;
  }
  
  .meter-circle {
    width: 240px;
    height: 240px;
  }
  
  .meter-circle .reading {
    font-size: 3rem;
  }
  
  #welcomeMessage {
    font-size: 2.2rem;
    margin: 2rem 0;
  }
  
  .card {
    padding: 2rem;
  }
}

/* Liquid Fill Effect */
.liquid-fill {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  background: linear-gradient(135deg, rgba(0, 184, 148, 0.6), rgba(85, 239, 196, 0.8));
  border-radius: 50%;
  transition: height 0.5s ease;
  z-index: -1;
}
   </style>
</head>
<body>

  <!-- Top Bar -->
  <div class="top-bar">
    <div style="position: relative;">
      <button class="notif-button" id="notifBtn">
        Notifications
        <span class="notif-count" id="notifCount">0</span>
      </button>
      <div class="notif-popup" id="notifPopup">
        <ul id="notifList"></ul>
      </div>
    </div>
   <a class="logout-button" href="viewer.html">Bill rates</a>
   <a class="logout-button" id="messagesBtn">Messages</a>
   <a href="analytics.html" class="logout-button" id="analyticsBtn">Analytics</a>
   <button class="logout-button" id="logoutBtn">Logout</button>
  </div>

  <!-- Welcome Message -->
  <h1 id="welcomeMessage">Welcome, Residence</h1>

  <!-- Dashboard Grid -->
  <div class="dashboard-grid">

    <!-- Water Meter -->
    <div class="meter-circle">
      <div class="label">Object Count</div>
      <div class="reading" id="counterDisplay">00000</div>
      <div class="unit">entries</div>
    </div>

    <!-- Liters Display -->
    <div id="litersCard" class="card">
      <h2 style="color:#22c55e;">Liters Reading</h2>
      <p><strong>Current:</strong> <span id="litersReading">0.000</span> L</p>
    </div>

    <!-- Bill Summary -->
    <div id="billCard" class="card">
      <h2 style="color:#38bdf8;">Water Bill Summary</h2>
      <p><strong>Consumption:</strong> <span id="billConsumption">0</span></p>
      <p><strong>Total Bill:</strong> <span id="billAmount">0.00</span></p>
    </div>

    <!-- Switch -->
    <div class="switch-container">
      <p id="switchStatus">Switch Status: Loading...</p>
      <label class="toggle-switch">
        <input type="checkbox" id="switchInput" />
        <span class="slider"></span>
      </label>
    </div>

  </div>

  <!-- Alert Box -->
  <div id="alertBox"></div>

  <!-- Chat Popup -->
  <div id="chatPopup" class="chat-popup">
    <div class="chat-header">
      <span>Chat with Admin</span>
      <button id="closeChat" class="close-btn">Ã—</button>
    </div>
    <div id="chatMessages" class="chat-messages"></div>
    <form id="chatForm" class="chat-form">
      <input type="text" id="chatInput" placeholder="Type a message..." required />
      <button type="submit">Send</button>
    </form>
  </div>

  <!-- JavaScript -->
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDXNrUVM1VBaXOg2ZmkIFE9BKxexxBmpIs",
      authDomain: "waterbase-b1393.firebaseapp.com",
      databaseURL: "https://waterbase-b1393-default-rtdb.asia-southeast1.firebasedatabase.app/",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Paths and Elements
    const sensorPath = localStorage.getItem("sensorPath") || "/sensors1/water_timer_counter/value";
    const switchPath = localStorage.getItem("switchPath") || "/sensors1/control_switch/value";
    const alertPath  = localStorage.getItem("alertPath")  || "/sensors1/water_alerts";
    const username = localStorage.getItem("username") || "Residence";
    const currentUser = username;

    document.getElementById("welcomeMessage").innerText = `Welcome, ${username}`;

    const switchRef = db.ref(switchPath);
    const alertsRef = db.ref(alertPath);
    const switchStatus = document.getElementById("switchStatus");
    const switchInput = document.getElementById("switchInput");
    const alertBox = document.getElementById("alertBox");
    const notifList = document.getElementById("notifList");
    const notifPopup = document.getElementById("notifPopup");
    const notifCount = document.getElementById("notifCount");
    const notifBtn = document.getElementById("notifBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const meterCircle = document.querySelector('.meter-circle');

    let lastValue = null;
    let notifPopupOpen = false;
    let flowTimeout;
    const lastSeenTimestampKey = "lastSeenTimestamp";

    if (!localStorage.getItem(lastSeenTimestampKey)) {
      localStorage.setItem(lastSeenTimestampKey, Date.now());
      localStorage.setItem("unseenCount", 0);
    }

    let unseenCount = Number(localStorage.getItem("unseenCount")) || 0;
    notifCount.innerText = unseenCount;

    // Toggle notification popup
    notifBtn.addEventListener("click", () => {
      notifPopupOpen = !notifPopupOpen;
      notifPopup.style.display = notifPopupOpen ? "block" : "none";

      if (notifPopupOpen) {
        unseenCount = 0;
        notifCount.innerText = unseenCount;
        localStorage.setItem("unseenCount", unseenCount);
        localStorage.setItem(lastSeenTimestampKey, Date.now());
      }
    });

    // Logout
    logoutBtn.addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "index.html";
    });

    // Listen to switch changes
    switchRef.on("value", snap => {
      const val = snap.val();
      if (val === true || val === "true" || val === 1) {
        switchStatus.textContent = "Switch Status: ON";
        switchInput.checked = true;
      } else {
        switchStatus.textContent = "Switch Status: OFF";
        switchInput.checked = false;
      }
    });

    // Toggle switch
    switchInput.addEventListener("change", () => {
      switchRef.set(switchInput.checked);
    });

    // Water meter logic
    db.ref(sensorPath).on("value", snap => {
      const val = Number(snap.val()) || 0;
      document.getElementById("counterDisplay").innerText = String(val).padStart(5, "0");

      if (lastValue === null) {
        lastValue = val;
        return;
      }

      if (val > lastValue) {
        meterCircle.classList.add('flowing');
        clearTimeout(flowTimeout);
        flowTimeout = setTimeout(() => {
          meterCircle.classList.remove('flowing');
        }, 2000);

        const lastAlerted = Number(localStorage.getItem("lastAlertedPulses")) || 0;

        switchRef.get().then(snapSwitch => {
          const switchVal = snapSwitch.val();
          if ((!switchVal || switchVal === "false" || switchVal === 0) && val !== lastAlerted) {
            alertsRef.push({
              message: "Water leak detected",
              pulses: val,
              timestamp: Date.now(),
            });
            localStorage.setItem("lastAlertedPulses", val);
          }
        });
      }

      lastValue = val;
    });

    // Notifications UI
    alertsRef.on("value", snap => {
      const alerts = snap.val() || {};
      const alertEntries = Object.entries(alerts);
      alertEntries.sort((a, b) => b[1].timestamp - a[1].timestamp);
      notifList.innerHTML = "";
      const lastSeen = Number(localStorage.getItem(lastSeenTimestampKey)) || 0;
      let newUnseenCount = 0;

      alertEntries.forEach(([key, alert]) => {
        const li = document.createElement("li");
        li.textContent = `${alert.message} (${alert.pulses} pulses)`;
        const dismissBtn = document.createElement("button");
        dismissBtn.textContent = "Dismiss";
        dismissBtn.addEventListener("click", () => {
          alertsRef.child(key).remove();
        });
        li.appendChild(dismissBtn);
        notifList.appendChild(li);

        if (alert.timestamp > lastSeen) {
          newUnseenCount++;
        }
      });

      if (!notifPopupOpen && newUnseenCount > 0) {
        unseenCount = newUnseenCount;
        notifCount.innerText = unseenCount;
        localStorage.setItem("unseenCount", unseenCount);
      }
    });

    // Show most recent alert
    alertsRef.limitToLast(1).on("child_added", snap => {
      const alert = snap.val();
      alertBox.textContent = alert.message + " (" + alert.pulses + " pulses)";
      alertBox.style.display = "block";
      setTimeout(() => { alertBox.style.display = "none"; }, 5000);
    });

  // ==== CHAT FEATURE ====
const chatPopup = document.getElementById("chatPopup");
const closeChat = document.getElementById("closeChat");
const chatForm = document.getElementById("chatForm");
const chatInput = document.getElementById("chatInput");
const chatMessages = document.getElementById("chatMessages");
const messagesBtn = document.getElementById("messagesBtn");

// Match Firebase JSON structure: "Residence_Employee"
const chatRoom = `${currentUser}_Employee`;
const chatRef = db.ref(`chats/${chatRoom}`);

// Open chat when Messages button clicked
messagesBtn.addEventListener("click", () => {
  chatPopup.style.display = "flex";
});

// Close chat
closeChat.addEventListener("click", () => {
  chatPopup.style.display = "none";
});

// Send message
chatForm.addEventListener("submit", e => {
  e.preventDefault();
  const msg = chatInput.value.trim();
  if (!msg) return;
  chatRef.push({ sender: currentUser, text: msg, timestamp: Date.now() });
  chatInput.value = "";
});

// Receive messages (Residence + Employee)
chatRef.on("child_added", snap => {
  const msg = snap.val();
  const div = document.createElement("div");
  div.className = msg.sender === currentUser ? "sent" : "received";
  div.textContent = `${msg.sender}: ${msg.text}`;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
});

  // Notifications UI
    alertsRef.on("value", snap => {
      const alerts = snap.val() || {};
      const alertEntries = Object.entries(alerts);
      alertEntries.sort((a, b) => b[1].timestamp - a[1].timestamp);
      notifList.innerHTML = "";
      const lastSeen = Number(localStorage.getItem(lastSeenTimestampKey)) || 0;
      let newUnseenCount = 0;

      alertEntries.forEach(([key, alert]) => {
        const dateStr = new Date(alert.timestamp).toLocaleString();
        const li = document.createElement("li");
        li.textContent = `${alert.message} at ${dateStr}`;
        const delBtn = document.createElement("button");
        delBtn.textContent = "Ã—";
        delBtn.setAttribute("aria-label", "Delete alert");
        delBtn.addEventListener("click", () => {
          alertsRef.child(key).remove();
        });
        li.appendChild(delBtn);
        notifList.appendChild(li);
        if (alert.timestamp > lastSeen) newUnseenCount++;
      });

      if (!notifPopupOpen) {
        unseenCount = newUnseenCount;
        notifCount.innerText = unseenCount;
        localStorage.setItem("unseenCount", unseenCount);
      }
    });

    alertsRef.limitToLast(1).on("child_added", snap => {
      const alert = snap.val();
      if (!alert) return;

      alertBox.textContent = alert.message;
      alertBox.style.display = "block";
      setTimeout(() => {
        alertBox.style.display = "none";
      }, 4000);

      // Browser Notification
      async function fireSystemNotification(title, message) {
        if (!("Notification" in window)) return;
        if (Notification.permission === "granted") {
          const reg = await navigator.serviceWorker.getRegistration();
          if (reg) {
            reg.showNotification(title, {
              body: message,
              icon: "https://cdn-icons-png.flaticon.com/512/1827/1827392.png",
              vibrate: [100, 50, 100],
              tag: "water-alert",
              renotify: true,
            });
          }
        }
      }

      // Call the notification
      fireSystemNotification("Water Leak Detected", alert.message);
    });

    // Request notification permission
    if ("Notification" in window && Notification.permission !== "granted") {
      Notification.requestPermission();
    }

    // Register Service Worker
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .register("sw.js")
        .then(reg => {
          console.log("Service Worker registered", reg.scope);
        })
        .catch(err => {
          console.error("Service Worker registration failed", err);
        });
    }
    // === Billing System ===
  let currentRates = null;
  let currentConsumption = 0;

  // Load rates
  db.ref("residential_water_rates").on("value", snap => {
    currentRates = snap.val();
    updateBill();
  });

  // Load consumption (already cubic meters)
  db.ref(sensorPath).on("value", snap => {
    currentConsumption = Number(snap.val()) || 0;
    updateBill();
  });

  function calculateBill(consumption) {
    if (!currentRates) return 0;
    let bill = 0;

    if (consumption <= 5) {
      bill = parseFloat(currentRates.r0_5);
    } else if (consumption <= 10) {
      bill = parseFloat(currentRates.r0_5);
      for (let i = 6; i <= consumption; i++) {
        bill += parseFloat(currentRates["r" + i]);
      }
    } else {
      bill = parseFloat(currentRates.r0_5);
      for (let i = 6; i <= 10; i++) {
        bill += parseFloat(currentRates["r" + i]);
      }
      if (consumption > 10) {
        let extra = Math.min(consumption, 20) - 10;
        bill += extra * parseFloat(currentRates.r11_20);
      }
      if (consumption > 20) {
        let extra = Math.min(consumption, 30) - 20;
        bill += extra * parseFloat(currentRates.r21_30);
      }
      if (consumption > 30) {
        let extra = Math.min(consumption, 40) - 30;
        bill += extra * parseFloat(currentRates.r31_40);
      }
      if (consumption > 40) {
        let extra = Math.min(consumption, 50) - 40;
        bill += extra * parseFloat(currentRates.r41_50);
      }
      if (consumption > 50) {
        let extra = consumption - 50;
        bill += extra * parseFloat(currentRates.r51_up);
      }
    }
    return bill;
  }

  function updateBill() {
    if (!currentRates) return;
    const bill = calculateBill(currentConsumption);
    document.getElementById("billConsumption").textContent = currentConsumption + " mÂ³";
    document.getElementById("billAmount").textContent = "â‚±" + bill.toFixed(2);
  }
      
      
// System Notification Utility
async function fireSystemNotification(title, message) {
  if (!("Notification" in window)) return;
  if (Notification.permission === "granted") {
    const reg = await navigator.serviceWorker.getRegistration();
    if (reg) {
      reg.showNotification(title, {
        body: message,
        icon: "https://cdn-icons-png.flaticon.com/512/1827/1827392.png",
        vibrate: [100, 50, 100],
        tag: "chat-message",
        renotify: true,
      });
    }
  }
}

      chatRef.on("child_added", snap => {
  const msg = snap.val();
  const div = document.createElement("div");
  div.className = msg.sender === currentUser ? "sent" : "received";
  div.textContent = `${msg.sender}: ${msg.text}`;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;

  // Show browser notification if message is from someone else
  if (msg.sender !== currentUser) {
    fireSystemNotification("New Message", `${msg.sender}: ${msg.text}`);
  }
});
 
      
      // Request notification permission
if ("Notification" in window && Notification.permission !== "granted") {
  Notification.requestPermission();
}

// Register service worker
if ("serviceWorker" in navigator) {
  navigator.serviceWorker
    .register("sw.js")
    .then(reg => {
      console.log("Service Worker registered", reg.scope);
    })
    .catch(err => {
      console.error("Service Worker registration failed", err);
    });
}
 
    
      
      // Liters path
const litersPath = sensorPath.replace("water_timer_counter/value", "water_timer_liters/value");
const litersRef = db.ref(litersPath);

// Listen for liters updates
litersRef.on("value", snap => {
  const liters = Number(snap.val()) || 0;
  document.getElementById("litersReading").textContent = liters.toFixed(3);
});
      
      // === MONTHLY DATA SAVE SYSTEM ===
  const monthlyRef = db.ref(`monthly_usage/${currentUser}`);

  // Convert consumption to liters (if your currentConsumption is in cubic meters)
  function saveMonthlyData() {
    const now = new Date();
    const month = now.toLocaleString("default", { month: "long" }); // e.g. October
    const year = now.getFullYear();
    const litersUsed = currentConsumption * 1000; // 1 cubic meter = 1000 liters

    const monthKey = `${year}_${month}`; // e.g. 2025_October

    // Save/update Firebase record for this month
    monthlyRef.child(monthKey).set({
      month: month,
      year: year,
      consumption_m3: currentConsumption,
      consumption_liters: litersUsed,
      updatedAt: Date.now()
    });
  }

  // Whenever bill updates (so reading changes), also save data
  db.ref(sensorPath).on("value", snap => {
    currentConsumption = Number(snap.val()) || 0;
    updateBill();
    saveMonthlyData(); // Save automatically
  });

  // Add this to your existing JavaScript, after the litersRef listener:

// Enhanced liters detection with animations
let lastLitersValue = 0;
let litersAnimationTimeout;

litersRef.on("value", snap => {
  const liters = Number(snap.val()) || 0;
  const litersElement = document.getElementById("litersReading");
  
  // Update display with animation
  litersElement.textContent = liters.toFixed(3);
  
  // Add pulse animation to liters value
  litersElement.style.animation = 'none';
  setTimeout(() => {
    litersElement.style.animation = 'textPulse 0.6s ease';
  }, 10);
  
  // Activate meter circle animation when liters are detected
  if (liters > 0 && liters !== lastLitersValue) {
    const meterCircle = document.querySelector('.meter-circle');
    
    // Add liters-active class for green color and animations
    meterCircle.classList.add('liters-active');
    
    // Create water droplets effect
    createWaterDroplets();
    
    // Remove the class after animation completes
    clearTimeout(litersAnimationTimeout);
    litersAnimationTimeout = setTimeout(() => {
      meterCircle.classList.remove('liters-active');
    }, 2000);
  }
  
  lastLitersValue = liters;
});

// Function to create water droplet animations
function createWaterDroplets() {
  const meterCircle = document.querySelector('.meter-circle');
  const dropletsContainer = document.createElement('div');
  dropletsContainer.className = 'water-droplets';
  
  // Create multiple droplets
  for (let i = 0; i < 8; i++) {
    const droplet = document.createElement('div');
    droplet.className = 'droplet';
    droplet.style.left = `${Math.random() * 100}%`;
    droplet.style.animationDelay = `${Math.random() * 1.5}s`;
    droplet.style.animationDuration = `${1 + Math.random() * 2}s`;
    dropletsContainer.appendChild(droplet);
  }
  
  meterCircle.appendChild(dropletsContainer);
  
  // Remove droplets after animation
  setTimeout(() => {
    if (dropletsContainer.parentNode) {
      dropletsContainer.remove();
    }
  }, 3000);
}

// Add this CSS for text pulse animation
const style = document.createElement('style');
style.textContent = `
  @keyframes textPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); color: #55efc4; }
  }
`;
document.head.appendChild(style);

// Open chat when Messages button clicked
messagesBtn.addEventListener("click", () => {
  chatPopup.style.display = "flex";
  chatInput.focus();
  // Scroll to bottom when opening
  setTimeout(() => {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }, 100);
});

// Format timestamp
function formatTime(timestamp) {
  const date = new Date(timestamp);
  const now = new Date();
  const diff = now - date;
  
  // If less than 1 minute ago
  if (diff < 60000) {
    return 'Just now';
  }
  
  // If today
  if (date.toDateString() === now.toDateString()) {
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }
  
  // If yesterday
  const yesterday = new Date(now);
  yesterday.setDate(yesterday.getDate() - 1);
  if (date.toDateString() === yesterday.toDateString()) {
    return 'Yesterday ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }
  
  // Otherwise, show date and time
  return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}


  // Close chat when clicking outside
document.addEventListener('click', (e) => {
  if (chatPopup.style.display === 'flex' && 
      !chatPopup.contains(e.target) && 
      e.target !== messagesBtn) {
    chatPopup.style.display = 'none';
  }
});

  </script>
</body>
</html>
